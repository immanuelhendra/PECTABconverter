<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF → PECTAB Generator (ATB/BTP)</title>
<script src="https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #121822;
    --muted: #6c7a91;
    --accent: #4aa6ff;
    --text: #e7eefb;
    --ok: #39d98a;
    --warn: #ffb020;
    --bad: #ff6a69;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
  .wrap { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
  h1 { font-size: 1.6rem; margin: 0 0 12px; }
  p.lead { color: var(--muted); margin: 0 0 24px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
  @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
  .card { background: var(--panel); border: 1px solid #1e2633; border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .card h2 { margin: 0 0 12px; font-size: 1.1rem; color: #d6e4ff; }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
  input[type="file"] { background: #0f1520; border: 1px dashed #2a3446; color: var(--text); padding: 10px 12px; border-radius: 10px; }
  textarea, pre, input[type="text"] {
    width: 100%; box-sizing: border-box; background: #0f1520; color: var(--text);
    border: 1px solid #263043; border-radius: 10px; padding: 10px 12px; font-family: var(--mono); font-size: .92rem; line-height: 1.35; }
  textarea { min-height: 180px; }
  pre { min-height: 180px; white-space: pre-wrap; word-break: break-word; }
  .hint { font-size: .85rem; color: var(--muted); margin-top: 6px; }
  .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 20px; font-size: .82rem; }
  .ok { background: rgba(57,217,138,.12); color: var(--ok); border: 1px solid rgba(57,217,138,.3); }
  .warn { background: rgba(255,176,32,.12); color: var(--warn); border: 1px solid rgba(255,176,32,.3); }
  .bad { background: rgba(255,106,105,.12); color: var(--bad); border: 1px solid rgba(255,106,105,.3); }
  button {
    background: linear-gradient(180deg, #1b2738 0%, #152031 100%);
    color: var(--text); border: 1px solid #274063; padding: 10px 14px; border-radius: 10px; cursor: pointer;
    transition: transform .04s ease-out, box-shadow .2s; }
  button:hover { box-shadow: 0 6px 18px rgba(74,166,255,.18); }
  button:active { transform: translateY(1px); }
  .primary { background: linear-gradient(180deg, #1d61ff 0%, #1747c9 100%); border-color: #1d61ff; }
  .ghost { background: #0f1520; }
  .footer { margin-top: 20px; color: var(--muted); font-size: .85rem; text-align: center; }
  .mono { font-family: var(--mono); }
  .small { font-size: .85rem; }
  .candidate { padding: 8px; border: 1px solid #263043; border-radius: 8px; background: #0f1520; margin-top: 6px; }
  .candidate code { font-family: var(--mono); font-size: .85rem; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>PDF → PECTAB Generator (ATB/BTP)</h1>
    <p class="lead">Upload your PDF; I’ll detect the ATB/BTP data line (no “data:” label needed) and append it to your PECTAB template.</p>

    <div class="grid">
      <div class="card">
        <h2>1) Upload PDF</h2>
        <input id="pdfFile" type="file" accept="application/pdf" />
        <div id="pdfStatus" class="hint">Waiting for PDF…</div>

        <div class="row">
          <button id="extractBtn" class="ghost">Auto-detect ATB/BTP Line</button>
        </div>

        <div class="row" style="margin-top:12px">
          <span id="detectBadge" class="badge warn">Nothing detected yet</span>
        </div>

        <div id="candidatesBox" class="hint" style="margin-top:10px; display:none">
          <div class="small" style="margin-bottom:6px">I found multiple candidates. Pick one:</div>
          <div id="candidates"></div>
        </div>

        <h2 style="margin-top:18px">Detected Result</h2>
        <label for="dataBlock" class="small">Detected data string (editable):</label>
        <textarea id="dataBlock" placeholder="e.g. BTP010101#01HU/HAISHENGMR#0201#0323  ... #86BEIJING#$"></textarea>

        <div class="row">
          <label class="small"><input id="ensureDollar" type="checkbox" checked /> Ensure data ends with ‘$’</label>
        </div>

        <div class="row">
          <button id="copyData">Copy Data</button>
        </div>
      </div>

      <div class="card">
        <h2>2) PECTAB Template</h2>
        <label for="pectabTpl" class="small">Template (pre-filled from your sample; feel free to modify):</label>
        <textarea id="pectabTpl">AD;BTT0101]F0510250=#01C0 5255490201#02C0 5255150201#03C0 5255090201#04C0 5259180201#05C0 1000990201#06K0 A003250202#07C0 1000990201#08C0 5259490201#09I1 A007250632#0AC0 5474120201#0BC0 1000990201#10C0M1216020303#11C0M1216130303#12C0M1216310303#15C0MA224261006#16C0MA220260302#17C0 1000990201#18C0MA224440605#20C0M1196020303#21C0M1196130303#22C0M1196310303#25C0MA204261006#26C0MA200260302#27C0 1000990201#28C0MA204440605#30C0M1176020303#31C0M1176130303#32C0M1176310303#35C0MA184261006#36C0MA180260302#37C0 1000990201#38C0MA184440605#40C0 1000990201#41C0 1000990201#42C0 1000990201#45C0 1000990201#46C0 1000990201#47C0 1000990201#48C0 1000990201#77C0 1000990201#78C0M2159061408#80C0 1014050201#81C0 1014110201#82C0 1014230201#85C0 1014380201#86C0 1000990201#87C0 1000990201#88C0 1000990201#A1C0 5491490201=30#A2C0 5491430201=31#A3C0 5491300201=32#A4C0 5491130201=35#A5C0 5487490201=20#A6C0 5487430201=21#A7C0 5487300201=22#A8C0 5487130201=25#A9C0 5483490201=10#AAC0 5483430201=11#ABC0 5483300201=12#ACC0 5483130201=15#ADC0 E479250201=16#AEC0 5474490201BAG:#AFC0 5474390201=02#B0C0 5474350201/#B1C0 5474330201=03#B2C0 5474240201B/NO:#B3C0 5470490201=01#B4K0 E465250303=06#B5I1 E461260532=09#B6C0 5259420201/#B7C0 5259400201=82#B8C0 5255110201/#B9S0MA235250250#BAC0M1231020302TO#BBS0MA215250250#BCC0M1211020302VIA#BDS0MA195250250#BEC0M1191020302VIA#BFS0MA175250250#C0I1MC132474341=09#C1I1MA069254041=09#C2K0MA065250202=06#C3C0 1054380201=85#C4C0 1054230201=82#C5C0 1054110201=81#C6C0 1054050201=80#C7I1 A047250632=09#C8K0 A043250202=06#C9C0 1034380201=85#CAC0 1034230201=82#CBC0 1034110201=81#CCC0 1034050201=80#CDI1 A027250632=09#CEK0 A023250202=06#</textarea>
        <div class="hint">Leave as is, or paste your own template.</div>

        <div class="row">
          <label class="small"><input id="ensureOneDollar" type="checkbox" checked /> Avoid double <span class="mono">$$</span> when merging</label>
        </div>

        <div class="row">
          <button id="generateBtn" class="primary">Generate PECTAB</button>
          <button id="copyFinal">Copy Final</button>
          <button id="downloadFinal">Download .txt</button>
        </div>

        <h2 style="margin-top:18px">Final PECTAB Output</h2>
        <textarea id="finalOut" placeholder="Your merged PECTAB will appear here…"></textarea>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>3) Extracted Raw PDF Text (debug view)</h2>
      <pre id="pdfText">— none yet —</pre>
      <div class="hint">Detector looks for strings beginning with <span class="mono">ATB</span> or <span class="mono">BTP</span> + 6 digits, containing many <span class="mono">#</span> segments, and (ideally) ending with <span class="mono">$</span>.</div>
    </div>

    <div class="footer">
      Want me to insert the data at a placeholder (e.g. <span class="mono">{{DATA}}</span>) instead of appending? I can adjust easily.
    </div>
  </div>

<script>
  // PDF.js worker
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
  }

  const $ = sel => document.querySelector(sel);

  const els = {
    file: $('#pdfFile'),
    status: $('#pdfStatus'),
    extract: $('#extractBtn'),
    detectBadge: $('#detectBadge'),
    candidatesBox: $('#candidatesBox'),
    candidates: $('#candidates'),
    dataBlock: $('#dataBlock'),
    ensureDollar: $('#ensureDollar'),
    ensureOneDollar: $('#ensureOneDollar'),
    copyData: $('#copyData'),
    tpl: $('#pectabTpl'),
    gen: $('#generateBtn'),
    copyFinal: $('#copyFinal'),
    downloadFinal: $('#downloadFinal'),
    final: $('#finalOut'),
    pdfText: $('#pdfText'),
  };

  function setBadge(type, text) {
    els.detectBadge.className = 'badge ' + type;
    els.detectBadge.textContent = text;
  }

  function cleanText(s) {
    return (s || '')
      .replace(/\u00A0/g, ' ')
      .replace(/[ \t]+\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n');
  }

  // Read entire PDF text (page by page) using PDF.js
  async function readPdfTextFromFile(file) {
    els.status.textContent = 'Reading PDF…';
    const buf = await file.arrayBuffer();

    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let full = '';
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const text = content.items.map(i => i.str).join(' ');
      full += `\n\n===== PAGE ${p}/${pdf.numPages} =====\n` + text;
    }
    return cleanText(full);
  }

  // Heuristics: extract ATB/BTP data candidates without needing a "data:" label
  function extractCandidates(txt) {
    const lines = txt.split(/\r?\n/);
    const candidates = [];

    function scoreCandidate(s) {
      const hashCount = (s.match(/#/g) || []).length;
      const hasDollar = /\$/.test(s);
      const length = s.length;
      // Prefer many fields, presence of $, and reasonable length
      return hashCount * 5 + (hasDollar ? 10 : 0) + Math.min(length, 800) / 80;
    }

    function normalize(s) {
      return s.replace(/\s{2,}/g, ' ').trim();
    }

    // Pass 1: line-based scan; if wrap occurs, join up to next 2 lines
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i].trim();
      if (/(?:^|\s)(ATB|BTP)\d{6}/.test(l)) {
        let chunk = l;
        // If no '$' yet, try to glue next lines (PDF wraps)
        let j = i + 1;
        while (!/\$/.test(chunk) && j < Math.min(i + 3, lines.length)) {
          const nxt = lines[j].trim();
          if (nxt) chunk += ' ' + nxt;
          j++;
        }
        chunk = normalize(chunk);
        // Keep candidates that have at least a few fields (#…)
        if ((chunk.match(/#/g) || []).length >= 4) {
          candidates.push({ text: chunk, score: scoreCandidate(chunk), why: 'line-join' });
        }
      }
    }

    // Pass 2: global regex over normalized text (collapsed spaces)
    const flat = normalize(txt.replace(/\s+/g, ' '));
    // Capture from ATB/BTP + 6 digits up to the next '$' (cap length to avoid runaway)
    const re = /(?:^|\s)((?:ATB|BTP)\d{6}[^$]{0,2000}\$)/g;
    let m;
    while ((m = re.exec(flat)) !== null) {
      const cand = normalize(m[1]);
      if ((cand.match(/#/g) || []).length >= 4) {
        candidates.push({ text: cand, score: scoreCandidate(cand), why: 'global-$' });
      }
    }

    // If still none, try a looser “no-$ yet” window after ATB/BTP (take ~1000 chars)
    if (candidates.length === 0) {
      const re2 = /(?:^|\s)((?:ATB|BTP)\d{6}[^]{0,1000})/g;
      while ((m = re2.exec(flat)) !== null) {
        let cand = normalize(m[1]);
        // Truncate at first '  ' double-space boundary after many # or at next page marker
        const dbl = cand.indexOf('  ');
        if (dbl > 0 && dbl > 60) cand = cand.slice(0, dbl);
        if ((cand.match(/#/g) || []).length >= 6) {
          candidates.push({ text: cand, score: scoreCandidate(cand), why: 'global-loose' });
        }
      }
    }

    // Deduplicate by text
    const dedup = [];
    const seen = new Set();
    for (const c of candidates) {
      const key = c.text;
      if (!seen.has(key)) { seen.add(key); dedup.push(c); }
    }

    // Sort by score descending
    dedup.sort((a, b) => b.score - a.score);
    return dedup;
  }

  function ensureEndsWithDollar(s) {
    if (!s) return s;
    if (!/\$$/.test(s.trim())) return s.trim() + '$';
    return s.trim();
  }

  function preventDoubleDollar(merged) {
    return merged.replace(/\$\s*\$/g, '$');
  }

  function renderCandidates(cands) {
    const box = els.candidates;
    box.innerHTML = '';
    cands.forEach((c, idx) => {
      const id = 'cand_' + idx;
      const div = document.createElement('div');
      div.className = 'candidate';
      div.innerHTML = `
        <label style="display:flex; gap:8px; align-items:flex-start; cursor:pointer">
          <input type="radio" name="cand" id="${id}" value="${idx}" ${idx===0?'checked':''} />
          <div>
            <div class="small" style="margin-bottom:6px"><strong>Candidate ${idx+1}</strong> <span class="hint">(${c.why}, score ${c.score.toFixed(1)})</span></div>
            <code>${c.text.replace(/</g,'&lt;')}</code>
          </div>
        </label>`;
      box.appendChild(div);
    });
    els.candidatesBox.style.display = cands.length > 1 ? 'block' : 'none';

    // Update textarea when selection changes
    box.addEventListener('change', () => {
      const sel = [...box.querySelectorAll('input[name="cand"]')].find(r => r.checked);
      if (sel) els.dataBlock.value = cands[Number(sel.value)].text;
    }, { once: true });

    // Seed textarea
    if (cands[0]) els.dataBlock.value = cands[0].text;
  }

  // EVENT: Extract data from uploaded PDF
  els.extract.addEventListener('click', async () => {
    const f = els.file.files?.[0];
    if (!f) {
      els.status.textContent = 'Please choose a PDF first.';
      setBadge('bad', 'No PDF selected');
      return;
    }
    try {
      setBadge('warn', 'Processing…');
      const txt = await readPdfTextFromFile(f);
      els.pdfText.textContent = txt || '— empty —';

      const cands = extractCandidates(txt);

      if (cands.length > 0) {
        renderCandidates(cands);
        els.status.textContent = cands.length === 1 ? '1 candidate found.' : `${cands.length} candidates found (best preselected).`;
        setBadge('ok', 'ATB/BTP data detected');
      } else {
        els.dataBlock.value = '';
        els.candidatesBox.style.display = 'none';
        els.status.textContent = 'Could not detect ATB/BTP line. You can paste it manually.';
        setBadge('bad', 'Not found');
      }
    } catch (err) {
      console.error(err);
      els.status.textContent = 'Error reading PDF. See console for details.';
      setBadge('bad', 'Error while reading PDF');
    }
  });

  // EVENT: Generate merged PECTAB
  els.gen.addEventListener('click', () => {
    let tpl = (els.tpl.value || '').trim();
    let data = (els.dataBlock.value || '').trim();

    if (!tpl) {
      alert('Your PECTAB template is empty.');
      return;
    }
    if (!data) {
      if (!confirm('No data string detected. Continue with template only?')) return;
    }

    if (els.ensureDollar.checked && data) {
      data = ensureEndsWithDollar(data);
    }

    let merged = tpl;
    if (data) {
      merged = tpl + '\n' + data;
      if (els.ensureOneDollar.checked) merged = preventDoubleDollar(merged);
    }

    els.final.value = merged;
  });

  // Copy helpers
  function copyToClipboard(el, label = 'Text') {
    el.select();
    document.execCommand('copy');
    const prev = document.title;
    document.title = `${label} copied`;
    setTimeout(() => (document.title = prev), 600);
  }
  els.copyData.addEventListener('click', () => copyToClipboard(els.dataBlock, 'Data'));
  els.copyFinal.addEventListener('click', () => copyToClipboard(els.final, 'PECTAB'));

  // Download final
  els.downloadFinal.addEventListener('click', () => {
    const blob = new Blob([els.final.value || ''], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `pectab-${stamp}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
</script>
</body>
</html>

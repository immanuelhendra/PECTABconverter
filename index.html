<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATB/BTP PDF → PECTAB</title>

<!-- PDF.js core (worker set below) -->
<script src="https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
<script>
  // Always set an explicit worker; fixes most “fake worker”/CORS errors
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.js";
  }
</script>

<style>
  :root {
    --bg:#0b0f14; --panel:#121822; --muted:#6c7a91; --text:#e7eefb;
    --accent:#4aa6ff; --ok:#39d98a; --warn:#ffb020; --bad:#ff6a69;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:36px auto;padding:0 16px}
  h1{margin:0 0 10px;font-size:1.6rem}
  p.lead{margin:0 0 18px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid #1e2633;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0 0 10px;color:#d6e4ff;font-size:1.05rem}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  input[type=file],textarea{width:100%;box-sizing:border-box;background:#0f1520;color:var(--text);
    border:1px solid #263043;border-radius:10px;padding:10px 12px}
  textarea{font-family:var(--mono);min-height:140px}
  pre{background:#0f1520;color:var(--text);border:1px solid #263043;border-radius:10px;padding:12px;white-space:pre-wrap;word-break:break-word;min-height:140px}
  .hint{color:var(--muted);font-size:.9rem}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:20px;font-size:.82rem}
  .ok{background:rgba(57,217,138,.12);color:var(--ok);border:1px solid rgba(57,217,138,.3)}
  .warn{background:rgba(255,176,32,.12);color:var(--warn);border:1px solid rgba(255,176,32,.3)}
  .bad{background:rgba(255,106,105,.12);color:var(--bad);border:1px solid rgba(255,106,105,.3)}
  button{background:linear-gradient(180deg,#1b2738 0%,#152031 100%);color:var(--text);border:1px solid #274063;
    padding:10px 14px;border-radius:10px;cursor:pointer;transition:transform .04s, box-shadow .2s}
  button:hover{box-shadow:0 6px 18px rgba(74,166,255,.18)} button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#1d61ff 0%,#1747c9 100%);border-color:#1d61ff}
  .mono{font-family:var(--mono)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ATB/BTP PDF → PECTAB</h1>
    <p class="lead">Upload your custom ATB/BTP PDF. I’ll read its text (client-side) and show: <strong>PECTAB</strong>, <strong>Template</strong>, and <strong>Data</strong>.</p>

    <div class="grid">
      <div class="card">
        <h2>1) Upload PDF & Extract Text</h2>
        <input id="pdfFile" type="file" accept="application/pdf" />
        <div class="row">
          <button id="btnExtract">Read PDF Text</button>
          <span id="status" class="badge warn">Waiting for PDF…</span>
        </div>
        <div class="hint" style="margin-top:6px">
          If you open this file directly and see a worker error, serve it locally (e.g. <span class="mono">python -m http.server</span>) so the worker can load.
        </div>
        <h2 style="margin-top:14px">Raw PDF Text (debug)</h2>
        <pre id="rawText">— none yet —</pre>
      </div>

      <div class="card">
        <h2>2) Detected Outputs</h2>
        <div class="hint">Click <em>Parse</em> after extraction. Edit anything you like.</div>

        <h3 style="margin:12px 0 6px">PECTAB (ATB/BTP)</h3>
        <textarea id="pectabOut" placeholder="Full PECTAB code…"></textarea>

        <h3 style="margin:12px 0 6px">Template (optional)</h3>
        <textarea id="pectabTpl" placeholder="Template detected (if present)…"></textarea>

        <h3 style="margin:12px 0 6px">Data (optional)</h3>
        <textarea id="dataLine" placeholder="ATB010101… or BTP010101…#$"></textarea>

        <div class="row" style="margin-top:8px">
          <button id="btnParse" class="primary">Parse</button>
          <button id="btnCopyPectab">Copy PECTAB</button>
          <button id="btnCopyTemplate">Copy Template</button>
          <button id="btnCopyData">Copy Data</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>3) How parsing works</h2>
      <ul>
        <li><strong>PECTAB</strong>: longest <span class="mono">AD;</span>… block with many <span class="mono">#</span> fields.</li>
        <li><strong>Data</strong>: best match of <span class="mono">ATB/BTP</span> + 6 digits with many <span class="mono">#</span>; trailing <span class="mono">$</span> added if missing.</li>
        <li><strong>Template</strong>: another PECTAB-like block labelled <em>Template</em>/<em>Mockup</em>/<em>Example</em> if present; else it’s left blank.</li>
      </ul>
    </div>
  </div>

<script>
  // ------------- helpers -------------
  const $ = (s)=>document.querySelector(s);
  const els = {
    file: $('#pdfFile'), btnExtract: $('#btnExtract'), status: $('#status'), rawText: $('#rawText'),
    pectabOut: $('#pectabOut'), pectabTpl: $('#pectabTpl'), dataLine: $('#dataLine')
  };
  function setBadge(kind, txt){ els.status.className = 'badge ' + kind; els.status.textContent = txt; }
  function cleanText(s){ return (s||'').replace(/\u00A0/g,' ').replace(/[ \t]+\n/g,'\n').replace(/\n{3,}/g,'\n\n'); }
  function normalizeSpaces(s){ return (s||'').replace(/\u00A0/g,' ').replace(/[ \t]+/g,' ').trim(); }

  // ------------- PDF text extraction (with fallback) -------------
  els.btnExtract.addEventListener('click', async ()=>{
    const f = els.file.files?.[0];
    if (!f) { setBadge('bad','No PDF selected'); return; }

    try {
      const buf = await f.arrayBuffer();
      let text = '';

      async function extractWith(opts){
        const pdf = await pdfjsLib.getDocument(Object.assign({ data: buf }, opts || {})).promise;
        for (let p = 1; p <= pdf.numPages; p++){
          const page = await pdf.getPage(p);
          const content = await page.getTextContent({ includeMarkedContent:false });
          text += `\n\n===== PAGE ${p}/${pdf.numPages} =====\n` + content.items.map(i=>i.str).join(' ');
        }
      }

      try {
        await extractWith(); // normal path
      } catch (err) {
        console.warn('Worker issue — retrying without worker', err);
        // fallback that works when opened from file:// or strict CSP
        await extractWith({ isEvalSupported:false, useWorkerFetch:false, disableAutoFetch:false });
      }

      els.rawText.textContent = cleanText(text) || '— empty —';
      setBadge('ok','Text extracted');
    } catch (e) {
      console.error(e);
      setBadge('bad','Error while reading PDF');
    }
  });

  // ------------- detectors (custom ATB/BTP) -------------
  function detectData(flat){
    const candidates = []; let m;
    // Prefer strings that end with $
    const greedy = /\b((?:ATB|BTP)\d{6}[^$]{0,3000}\$)/g;
    while((m = greedy.exec(flat)) !== null) candidates.push(m[1]);

    // If none end with $, allow non-$ and we’ll add it
    if (candidates.length === 0) {
      const loose = /\b((?:ATB|BTP)\d{6}[^]{0,1200})/g;
      while((m = loose.exec(flat)) !== null) candidates.push(m[1]);
    }

    function score(s){
      const hashes = (s.match(/#/g) || []).length;
      const hasDollar = /\$\s*$/.test(s) ? 5 : 0;
      return hashes*5 + hasDollar + Math.min(s.length,1200)/80;
    }
    candidates.sort((a,b)=>score(b)-score(a));

    let best = candidates[0] ? normalizeSpaces(candidates[0]) : '';
    if (best && !/\$$/.test(best)) best += '$';
    return best;
  }

  function detectPectab(flat){
    const hits = []; let m;
    const re = /\b(AD;[^]{50,8000})/g;
    while((m = re.exec(flat)) !== null) hits.push(m[1]);
    const good = hits.filter(s => (s.match(/#/g) || []).length >= 15);
    if (good.length === 0) return '';
    good.sort((a,b)=> (b.match(/#/g)||[]).length - (a.match(/#/g)||[]).length);
    return normalizeSpaces(good[0]);
  }

  function detectTemplate(flat){
    const tag = /\b(TEMPLATE|MOCKUP|EXAMPLE)\b\s*[:\-]?\s*(AD;[^]{30,4000})/i.exec(flat);
    return tag ? normalizeSpaces(tag[2]) : '';
  }

  // ------------- Parse + copy -------------
  $('#btnParse').addEventListener('click', ()=>{
    const flat = normalizeSpaces(($('#rawText').textContent || '').replace(/\s+/g,' '));
    if (!flat || /— none yet —/.test(flat)) { setBadge('bad','Extract text first'); return; }
    els.pectabOut.value = detectPectab(flat) || '';
    els.dataLine.value = detectData(flat) || '';
    els.pectabTpl.value = detectTemplate(flat) || '';
    setBadge('ok','Parsed');
  });

  function copy(el){ el.select(); document.execCommand('copy'); }
  $('#btnCopyPectab').addEventListener('click', ()=>copy(els.pectabOut));
  $('#btnCopyTemplate').addEventListener('click', ()=>copy(els.pectabTpl));
  $('#btnCopyData').addEventListener('click', ()=>copy(els.dataLine));
</script>
</body>
</html>

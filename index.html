<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF → PECTAB Generator (ATB/BTP)</title>
<!-- PDF.js (stable) -->
<script src="https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #121822;
    --muted: #6c7a91;
    --accent: #4aa6ff;
    --text: #e7eefb;
    --ok: #39d98a;
    --warn: #ffb020;
    --bad: #ff6a69;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html, body {
    margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  }
  .wrap {
    max-width: 1100px; margin: 40px auto; padding: 0 16px;
  }
  h1 { font-size: 1.6rem; margin: 0 0 12px; }
  p.lead { color: var(--muted); margin: 0 0 24px; }
  .grid {
    display: grid; grid-template-columns: 1fr; gap: 16px;
  }
  @media (min-width: 1000px) {
    .grid { grid-template-columns: 1fr 1fr; }
  }
  .card {
    background: var(--panel); border: 1px solid #1e2633; border-radius: 12px; padding: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  .card h2 {
    margin: 0 0 12px; font-size: 1.1rem; color: #d6e4ff;
  }
  .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
  input[type="file"] {
    background: #0f1520; border: 1px dashed #2a3446; color: var(--text);
    padding: 10px 12px; border-radius: 10px;
  }
  textarea, pre, input[type="text"] {
    width: 100%; box-sizing: border-box;
    background: #0f1520; color: var(--text);
    border: 1px solid #263043; border-radius: 10px;
    padding: 10px 12px; font-family: var(--mono); font-size: 0.92rem; line-height: 1.35;
  }
  textarea { min-height: 180px; }
  pre { min-height: 180px; white-space: pre-wrap; word-break: break-word; }
  .hint { font-size: 0.85rem; color: var(--muted); margin-top: 6px; }
  .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 20px; font-size: 0.82rem; }
  .ok { background: rgba(57,217,138,0.12); color: var(--ok); border: 1px solid rgba(57,217,138,0.3); }
  .warn { background: rgba(255,176,32,0.12); color: var(--warn); border: 1px solid rgba(255,176,32,0.3); }
  .bad { background: rgba(255,106,105,0.12); color: var(--bad); border: 1px solid rgba(255,106,105,0.3); }
  button {
    background: linear-gradient(180deg, #1b2738 0%, #152031 100%);
    color: var(--text); border: 1px solid #274063; padding: 10px 14px; border-radius: 10px; cursor: pointer;
    transition: transform .04s ease-out, box-shadow .2s;
  }
  button:hover { box-shadow: 0 6px 18px rgba(74,166,255,.18); }
  button:active { transform: translateY(1px); }
  .primary { background: linear-gradient(180deg, #1d61ff 0%, #1747c9 100%); border-color: #1d61ff; }
  .ghost { background: #0f1520; }
  .footer {
    margin-top: 20px; color: var(--muted); font-size: 0.85rem; text-align: center;
  }
  .mono { font-family: var(--mono); }
  .small { font-size: 0.85rem; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>PDF → PECTAB Generator (ATB/BTP)</h1>
    <p class="lead">Upload your PDF; I’ll detect the <span class="mono">data:</span> field and append it to your PECTAB template.</p>

    <div class="grid">
      <div class="card">
        <h2>1) Upload PDF</h2>
        <input id="pdfFile" type="file" accept="application/pdf" />
        <div id="pdfStatus" class="hint">Waiting for PDF…</div>

        <div class="row">
          <button id="extractBtn" class="ghost">Extract “data:” From PDF</button>
        </div>

        <div class="hint" style="margin-top:8px">
          The extractor scans all pages for <span class="mono">data:</span> (case-insensitive), then captures the next non-empty line as your data string.
        </div>

        <div class="row" style="margin-top:12px">
          <span id="detectBadge" class="badge warn">No data detected yet</span>
        </div>

        <h2 style="margin-top:18px">Detect Result</h2>
        <label for="dataBlock" class="small">Detected data string (editable):</label>
        <textarea id="dataBlock" placeholder="e.g. BTP010101#01HU/HAISHENGMR#0201#0323  ... #86BEIJING#$"></textarea>

        <div class="row">
          <label class="small"><input id="ensureDollar" type="checkbox" checked /> Ensure data ends with ‘$’</label>
        </div>

        <div class="row">
          <button id="copyData">Copy Data</button>
        </div>
      </div>

      <div class="card">
        <h2>2) PECTAB Template</h2>
        <label for="pectabTpl" class="small">Template (pre-filled from your sample; feel free to modify):</label>
        <textarea id="pectabTpl">AD;BTT0101]F0510250=#01C0 5255490201#02C0 5255150201#03C0 5255090201#04C0 5259180201#05C0 1000990201#06K0 A003250202#07C0 1000990201#08C0 5259490201#09I1 A007250632#0AC0 5474120201#0BC0 1000990201#10C0M1216020303#11C0M1216130303#12C0M1216310303#15C0MA224261006#16C0MA220260302#17C0 1000990201#18C0MA224440605#20C0M1196020303#21C0M1196130303#22C0M1196310303#25C0MA204261006#26C0MA200260302#27C0 1000990201#28C0MA204440605#30C0M1176020303#31C0M1176130303#32C0M1176310303#35C0MA184261006#36C0MA180260302#37C0 1000990201#38C0MA184440605#40C0 1000990201#41C0 1000990201#42C0 1000990201#45C0 1000990201#46C0 1000990201#47C0 1000990201#48C0 1000990201#77C0 1000990201#78C0M2159061408#80C0 1014050201#81C0 1014110201#82C0 1014230201#85C0 1014380201#86C0 1000990201#87C0 1000990201#88C0 1000990201#A1C0 5491490201=30#A2C0 5491430201=31#A3C0 5491300201=32#A4C0 5491130201=35#A5C0 5487490201=20#A6C0 5487430201=21#A7C0 5487300201=22#A8C0 5487130201=25#A9C0 5483490201=10#AAC0 5483430201=11#ABC0 5483300201=12#ACC0 5483130201=15#ADC0 E479250201=16#AEC0 5474490201BAG:#AFC0 5474390201=02#B0C0 5474350201/#B1C0 5474330201=03#B2C0 5474240201B/NO:#B3C0 5470490201=01#B4K0 E465250303=06#B5I1 E461260532=09#B6C0 5259420201/#B7C0 5259400201=82#B8C0 5255110201/#B9S0MA235250250#BAC0M1231020302TO#BBS0MA215250250#BCC0M1211020302VIA#BDS0MA195250250#BEC0M1191020302VIA#BFS0MA175250250#C0I1MC132474341=09#C1I1MA069254041=09#C2K0MA065250202=06#C3C0 1054380201=85#C4C0 1054230201=82#C5C0 1054110201=81#C6C0 1054050201=80#C7I1 A047250632=09#C8K0 A043250202=06#C9C0 1034380201=85#CAC0 1034230201=82#CBC0 1034110201=81#CCC0 1034050201=80#CDI1 A027250632=09#CEK0 A023250202=06#</textarea>
        <div class="hint">Leave as is, or paste your own template.</div>

        <div class="row">
          <label class="small"><input id="ensureOneDollar" type="checkbox" checked /> Avoid double <span class="mono">$$</span> when merging</label>
        </div>

        <div class="row">
          <button id="generateBtn" class="primary">Generate PECTAB</button>
          <button id="copyFinal">Copy Final</button>
          <button id="downloadFinal">Download .txt</button>
        </div>

        <h2 style="margin-top:18px">Final PECTAB Output</h2>
        <textarea id="finalOut" placeholder="Your merged PECTAB will appear here…"></textarea>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>3) Extracted Raw PDF Text (debug view)</h2>
      <pre id="pdfText">— none yet —</pre>
      <div class="hint">This is just for visibility; extraction logic is based on the <span class="mono">data:</span> marker and next non-empty line.</div>
    </div>

    <div class="footer">
      Need tweaks (e.g., different marker rules, multi-line data blocks, or embedding data inside specific field IDs)? Tell me and I’ll adjust the parser.
    </div>
  </div>

<script>
  // PDF.js worker (same version as the core script)
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.7.76/build/pdf.worker.min.js';
  }

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const els = {
    file: $('#pdfFile'),
    status: $('#pdfStatus'),
    extract: $('#extractBtn'),
    detectBadge: $('#detectBadge'),
    dataBlock: $('#dataBlock'),
    ensureDollar: $('#ensureDollar'),
    ensureOneDollar: $('#ensureOneDollar'),
    copyData: $('#copyData'),
    tpl: $('#pectabTpl'),
    gen: $('#generateBtn'),
    copyFinal: $('#copyFinal'),
    downloadFinal: $('#downloadFinal'),
    final: $('#finalOut'),
    pdfText: $('#pdfText'),
  };

  function setBadge(type, text) {
    els.detectBadge.className = 'badge ' + type;
    els.detectBadge.textContent = text;
  }

  function cleanText(s) {
    return (s || '').replace(/\u00A0/g, ' ').replace(/\s+\n/g, '\n').replace(/\n{3,}/g, '\n\n');
  }

  function extractDataStringFromText(txt) {
    // Find the "data:" anchor (case-insensitive), capture the next non-empty line
    const lines = txt.split(/\r?\n/);
    let idx = lines.findIndex(l => /\bdata\s*:/i.test(l));
    if (idx === -1) return { data: '', reason: 'No "data:" label found' };

    // Look ahead for the first non-empty line
    let dataLine = '';
    for (let i = idx + 1; i < lines.length; i++) {
      const candidate = lines[i].trim();
      if (candidate.length > 0) {
        dataLine = candidate;
        break;
      }
    }
    if (!dataLine) return { data: '', reason: 'No non-empty line after "data:"' };

    // Normalize spaces inside data string (but keep everything else intact)
    dataLine = dataLine.replace(/\s{2,}/g, ' ').trim();

    return { data: dataLine, reason: '' };
  }

  async function readPdfTextFromFile(file) {
    els.status.textContent = 'Reading PDF…';
    const buf = await file.arrayBuffer();

    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let full = '';
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const text = content.items.map(i => i.str).join(' ');
      // Insert page separators for readability
      full += `\n\n===== PAGE ${p}/${pdf.numPages} =====\n` + text;
    }
    return cleanText(full);
  }

  function ensureEndsWithDollar(s) {
    if (!s) return s;
    if (!/\$$/.test(s.trim())) return s.trim() + '$';
    return s.trim();
  }

  function preventDoubleDollar(merged) {
    // Replace any occurrence of "$\n$" or "$$" at the join boundary
    return merged.replace(/\$\s*\$/g, '$');
  }

  // EVENT: Extract data from uploaded PDF
  els.extract.addEventListener('click', async () => {
    const f = els.file.files?.[0];
    if (!f) {
      els.status.textContent = 'Please choose a PDF first.';
      setBadge('bad', 'No PDF selected');
      return;
    }
    try {
      setBadge('warn', 'Processing…');
      const txt = await readPdfTextFromFile(f);
      els.pdfText.textContent = txt || '— empty —';

      const { data, reason } = extractDataStringFromText(txt);
      if (data) {
        els.dataBlock.value = data;
        els.status.textContent = 'Data detected.';
        setBadge('ok', 'Data detected');
      } else {
        els.dataBlock.value = '';
        els.status.textContent = `Couldn’t find data string: ${reason}`;
        setBadge('bad', 'Data not found');
      }
    } catch (err) {
      console.error(err);
      els.status.textContent = 'Error reading PDF. See console for details.';
      setBadge('bad', 'Error while reading PDF');
    }
  });

  // EVENT: Generate merged PECTAB
  els.gen.addEventListener('click', () => {
    let tpl = (els.tpl.value || '').trim();
    let data = (els.dataBlock.value || '').trim();

    if (!tpl) {
      alert('Your PECTAB template is empty.');
      return;
    }
    if (!data) {
      if (!confirm('No data string detected. Continue with template only?')) return;
    }

    if (els.ensureDollar.checked) {
      data = ensureEndsWithDollar(data);
    }

    let merged;
    // Append as newline + data (keeps your template intact)
    if (data) {
      merged = tpl + '\n' + data;
      if (els.ensureOneDollar.checked) merged = preventDoubleDollar(merged);
    } else {
      merged = tpl;
    }

    els.final.value = merged;
  });

  // Copy helpers
  function copyToClipboard(el, label = 'Text') {
    el.select();
    document.execCommand('copy');
    const old = el.value;
    // Minimal toast:
    const prev = document.title;
    document.title = `${label} copied`;
    setTimeout(() => (document.title = prev), 600);
  }
  els.copyData.addEventListener('click', () => copyToClipboard(els.dataBlock, 'Data'));
  els.copyFinal.addEventListener('click', () => copyToClipboard(els.final, 'PECTAB'));

  // Download final
  els.downloadFinal.addEventListener('click', () => {
    const blob = new Blob([els.final.value || ''], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `pectab-${stamp}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
</script>
</body>
</html>
